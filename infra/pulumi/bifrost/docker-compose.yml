x-default: &default
  restart: 'unless-stopped'
  logging:
    driver: 'json-file'
    options:
      max-size: '500m'
      max-file: '2'

networks:
  bifrost_net:
    driver: bridge

volumes:
  authentik_postgres_data:
  authentik_media:
  authentik_certs:
  caddy_data:
  caddy_config:
  netbird-mgmt:
  netbird-signal:
  netbird-letsencrypt:
  arcane-data:

services:
  caddy:
    image: caddy:2.11
    container_name: caddy
    networks:
      - bifrost_net
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------------
  # Authentik Services
  # --------------------------------------------------------------------------------

  authentik-postgres:
    image: postgres:16.6-alpine
    container_name: authentik-postgres
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - bifrost_net
    volumes:
      - authentik_postgres_data:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
      - POSTGRES_PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
      - POSTGRES_USER=authentik
      - POSTGRES_DB=authentik
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
  authentik-server:
    image: ghcr.io/goauthentik/server:2025.10.2
    container_name: authentik-server
    expose:
      - "9000"
    restart: unless-stopped
    command: server
    security_opt:
      - no-new-privileges:true
    networks:
      - bifrost_net
    env_file:
      - .env
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
    volumes:
      - authentik_media:/media
      - ./authentik-netbird-blueprint.yaml:/templates/netbird.yaml
    depends_on:
      authentik-postgres:
        condition: service_healthy

  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.10.2
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    security_opt:
      - no-new-privileges:true
    networks:
      - bifrost_net
    env_file:
      - .env
    environment:
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
    volumes:
      - authentik_media:/media
      - authentik_certs:/certs
      - ./authentik-netbird-blueprint.yaml:/templates/netbird.yaml
    depends_on:
      authentik-postgres:
        condition: service_healthy
  
    # UI dashboard
  
  # --------------------------------------------------------------------------------
  # Netbird Services
  # --------------------------------------------------------------------------------

  dashboard:
    <<: *default
    image: netbirdio/dashboard:v2.23.1
    container_name: netbird-dashboard
    ports: []
    networks:
      - bifrost_net
    environment:
      # Endpoints
      - NETBIRD_MGMT_API_ENDPOINT=https://netbird.madhan.app:443
      - NETBIRD_MGMT_GRPC_API_ENDPOINT=https://netbird.madhan.app:443
      # OIDC
      - AUTH_AUDIENCE=aumenijDycfG1cQURqH9BNJpV3KVUCoMHGPUVUlT
      - AUTH_CLIENT_ID=aumenijDycfG1cQURqH9BNJpV3KVUCoMHGPUVUlT
      - AUTH_CLIENT_SECRET=
      - AUTH_AUTHORITY=https://auth.madhan.app/application/o/netbird/
      - USE_AUTH0=false
      - AUTH_SUPPORTED_SCOPES=openid profile email offline_access api
      - AUTH_REDIRECT_URI=/auth
      - AUTH_SILENT_REDIRECT_URI=/silent-auth
      - NETBIRD_TOKEN_SOURCE=accessToken
      # SSL
      - NGINX_SSL_PORT=443
      # Letsencrypt
      - LETSENCRYPT_DOMAIN=
      - LETSENCRYPT_EMAIL=
    volumes:
      - netbird-letsencrypt:/etc/letsencrypt/

  # Signal
  signal:
    <<: *default
    image: netbirdio/signal:0.60.9
    container_name: netbird-signal
    networks:
      - bifrost_net
    depends_on:
          - dashboard
    volumes:
      - netbird-signal:/var/lib/netbird
      - netbird-letsencrypt:/etc/letsencrypt:ro
    ports: []
    command: [
      "--cert-file", "",
      "--cert-key", "",
      "--log-file", "console"
    ]

  # Relay
  relay:
    <<: *default
    image: netbirdio/relay:0.60.9
    container_name: netbird-relay
    networks:
      - bifrost_net
    env_file:
      - .env
    environment:
    - NB_LOG_LEVEL=info
    - NB_LISTEN_ADDRESS=:33080
    - NB_EXPOSED_ADDRESS=rels://netbird.madhan.app:33080/relay
    - NB_AUTH_SECRET=${NB_AUTH_SECRET}
    ports: []

  # Management
  management:
    <<: *default
    image: netbirdio/management:0.60.9
    container_name: netbird-management
    networks:
      - bifrost_net
    depends_on:
      - dashboard
    volumes:
      - netbird-mgmt:/var/lib/netbird
      - netbird-letsencrypt:/etc/letsencrypt:ro
      - ./management.json:/etc/netbird/management.json
    ports: []
    command: [
      "--port", "33073",
      "--log-file", "console",
      "--log-level", "info",
      "--disable-anonymous-metrics=false",
      "--single-account-mode-domain=netbird.madhan.app",
      "--dns-domain=netbird.selfhosted"
      ]
    environment:
      - NETBIRD_STORE_ENGINE_POSTGRES_DSN=
      - NETBIRD_STORE_ENGINE_MYSQL_DSN=
      
  # Coturn
  coturn:
    <<: *default
    image: coturn/coturn:4.7
    #domainname: netbird.madhan.app # only needed when TLS is enabled
    volumes:
      - ./turnserver.conf:/etc/turnserver.conf:ro
      # - ./privkey.pem:/etc/coturn/private/privkey.pem:ro
      # - ./cert.pem:/etc/coturn/certs/cert.pem:ro
    network_mode: host
    command:
      - -c /etc/turnserver.conf

  # --------------------------------------------------------------------------------
  # Arcane Services
  # --------------------------------------------------------------------------------

  arcane:
    image: ghcr.io/getarcaneapp/arcane:v1.10.1
    container_name: arcane
    networks:
      - bifrost_net
    expose:
      - "3552"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - arcane-data:/app/data
      - /etc/bifrost:/app/data/projects/bifrost
    env_file:
      - .env
    environment:
      - APP_URL=https://arcane.madhan.app
      - PUID=1000
      - PGID=1000
      - ENCRYPTION_KEY=${ARCANE_ENCRYPTION_KEY}
      - JWT_SECRET=${ARCANE_JWT_SECRET}
      - OIDC_ENABLED=true
      - OIDC_CLIENT_ID=uVxrDBfEraNi4DvFm8QbvPQxCRAqFVgDAmAqQ4pQ
      - OIDC_CLIENT_SECRET=${ARCANE_OIDC_CLIENT_SECRET}
      - OIDC_ISSUER_URL=https://auth.madhan.app/application/o/arcane/
      - OIDC_SCOPES=openid email profile
      - OIDC_ADMIN_CLAIM=groups
      - OIDC_ADMIN_VALUE=_arcane_admins
      - OIDC_MERGE_ACCOUNTS=true
    restart: unless-stopped
