x-default: &default
  restart: 'unless-stopped'
  logging:
    driver: 'json-file'
    options:
      max-size: '500m'
      max-file: '2'

networks:
  bifrost_net:
    driver: bridge

volumes:
  authentik_postgres_data:
  authentik_media:
  authentik_certs:
  caddy_data:
  caddy_config:
  netbird-mgmt:
  netbird-signal:

services:
  caddy:
    image: caddy:2.11
    container_name: caddy
    networks:
      - bifrost_net
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------------
  # Authentik Services
  # --------------------------------------------------------------------------------

  authentik-postgres:
    image: postgres:16.6-alpine
    container_name: authentik-postgres
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - bifrost_net
    volumes:
      - authentik_postgres_data:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
      - POSTGRES_PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
      - POSTGRES_USER=authentik
      - POSTGRES_DB=authentik
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
  authentik-server:
    image: ghcr.io/goauthentik/server:2025.10.2
    container_name: authentik-server
    expose:
      - "9000"
    restart: unless-stopped
    command: server
    security_opt:
      - no-new-privileges:true
    networks:
      - bifrost_net
    env_file:
      - .env
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
    volumes:
      - authentik_media:/media
      - ./authentik-netbird-blueprint.yaml:/templates/netbird.yaml
    depends_on:
      authentik-postgres:
        condition: service_healthy

  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.10.2
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    security_opt:
      - no-new-privileges:true
    networks:
      - bifrost_net
    env_file:
      - .env
    environment:
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
    volumes:
      - authentik_media:/media
      - authentik_certs:/certs
      - ./authentik-netbird-blueprint.yaml:/templates/netbird.yaml
    depends_on:
      authentik-postgres:
        condition: service_healthy

  # --------------------------------------------------------------------------------
  # Netbird Services
  # --------------------------------------------------------------------------------

  dashboard:
    <<: *default
    image: netbirdio/dashboard:v2.26.1
    container_name: netbird-dashboard
    networks:
      - bifrost_net
    env_file:
      - ./netbird/dashboard.env

  signal:
    <<: *default
    image: netbirdio/signal:0.62.2
    container_name: netbird-signal
    networks:
      - bifrost_net
    depends_on:
      - dashboard
    volumes:
      - netbird-signal:/var/lib/netbird
    ports: []
    command: [
      "--cert-file", "",
      "--cert-key", "",
      "--log-file", "console"
    ]

  relay:
    <<: *default
    image: netbirdio/relay:0.62.2
    container_name: netbird-relay
    networks:
      - bifrost_net
    env_file:
      - ./netbird/relay.env
    ports: []

  management:
    <<: *default
    image: netbirdio/management:0.62.2
    container_name: netbird-management
    networks:
      - bifrost_net
    depends_on:
      - dashboard
    volumes:
      - netbird-mgmt:/var/lib/netbird
      - ./netbird/management.json:/etc/netbird/management.json
    ports: []
    command: [
      "--port", "80",
      "--log-file", "console",
      "--log-level", "info",
      "--disable-anonymous-metrics=false",
      "--single-account-mode-domain=netbird.madhan.app",
      "--dns-domain=netbird.selfhosted",
      "--idp-sign-key-refresh-enabled"
    ]

  coturn:
    <<: *default
    image: coturn/coturn:4.7
    container_name: netbird-coturn
    volumes:
      - ./netbird/turnserver.conf:/etc/turnserver.conf:ro
    network_mode: host
    command:
      - -c /etc/turnserver.conf
