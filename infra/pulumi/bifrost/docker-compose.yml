x-default: &default
  restart: 'unless-stopped'
  logging:
    driver: 'json-file'
    options:
      max-size: '500m'
      max-file: '2'

networks:
  bifrost_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1

volumes:
  authentik_postgres_data:
  authentik_media:
  authentik_certs:
  traefik_certs:
  netbird_data:
  netbird_proxy_certs:

services:

  # --------------------------------------------------------------------------------
  # Traefik — TLS termination, ForwardAuth, K8s gateway routing
  # --------------------------------------------------------------------------------

  traefik:
    <<: *default
    image: traefik:v3.3
    container_name: traefik
    networks:
      bifrost_net:
        ipv4_address: 172.30.0.10
    ports:
      - "80:80"
      - "443:443"
      - "3478:3478/udp"   # STUN passthrough to netbird-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - traefik_certs:/certs
    env_file:
      - .env
      - .secrets.env
    security_opt:
      - no-new-privileges:true

  # --------------------------------------------------------------------------------
  # NetBird v0.66.0 — Combined server (Management + Signal + Relay + STUN)
  # --------------------------------------------------------------------------------

  netbird-server:
    <<: *default
    image: netbirdio/netbird-server:v0.66.0
    container_name: netbird-server
    networks: [bifrost_net]
    ports:
      - "3478:3478/udp"   # STUN (UDP bypasses Traefik)
    volumes:
      - netbird_data:/var/lib/netbird
      - ./netbird/config.yaml:/etc/netbird/config.yaml:ro
    command: ["--config", "/etc/netbird/config.yaml"]
    labels:
      - traefik.enable=true
      # gRPC router — signal + management (h2c backend for HTTP/2 cleartext)
      - "traefik.http.routers.netbird-grpc.rule=Host(`netbird.madhan.app`) && (PathPrefix(`/signalexchange.SignalExchange/`) || PathPrefix(`/management.ManagementService/`))"
      - traefik.http.routers.netbird-grpc.entrypoints=websecure
      - traefik.http.routers.netbird-grpc.tls.certResolver=cloudflare-dns
      - traefik.http.routers.netbird-grpc.service=netbird-server-h2c
      - traefik.http.routers.netbird-grpc.priority=100
      # Backend router — relay, WebSocket, API, OAuth2
      - "traefik.http.routers.netbird-backend.rule=Host(`netbird.madhan.app`) && (PathPrefix(`/relay`) || PathPrefix(`/ws-proxy/`) || PathPrefix(`/api`) || PathPrefix(`/oauth2`))"
      - traefik.http.routers.netbird-backend.entrypoints=websecure
      - traefik.http.routers.netbird-backend.tls.certResolver=cloudflare-dns
      - traefik.http.routers.netbird-backend.service=netbird-server
      - traefik.http.routers.netbird-backend.priority=100
      # Services
      - traefik.http.services.netbird-server.loadbalancer.server.port=80
      - traefik.http.services.netbird-server-h2c.loadbalancer.server.port=80
      - traefik.http.services.netbird-server-h2c.loadbalancer.server.scheme=h2c

  netbird-dashboard:
    <<: *default
    image: netbirdio/dashboard:latest
    container_name: netbird-dashboard
    networks: [bifrost_net]
    env_file:
      - ./netbird/dashboard.env
    labels:
      - traefik.enable=true
      - "traefik.http.routers.netbird-dashboard.rule=Host(`netbird.madhan.app`)"
      - traefik.http.routers.netbird-dashboard.entrypoints=websecure
      - traefik.http.routers.netbird-dashboard.tls.certResolver=cloudflare-dns
      - traefik.http.routers.netbird-dashboard.service=netbird-dashboard-svc
      - traefik.http.routers.netbird-dashboard.priority=1
      - traefik.http.services.netbird-dashboard-svc.loadbalancer.server.port=80

  # NetBird Reverse Proxy — expose feature (*.proxy.madhan.app TCP passthrough)
  netbird-proxy:
    <<: *default
    image: netbirdio/reverse-proxy:latest
    container_name: netbird-proxy
    networks: [bifrost_net]
    env_file:
      - ./netbird/proxy.env
    volumes:
      - netbird_proxy_certs:/certs

  # NetBird Agent — WireGuard routing peer, advertises 192.168.1.0/24 into mesh
  netbird-agent:
    <<: *default
    image: netbirdio/netbird:latest
    container_name: netbird-agent
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - NB_SETUP_KEY=${NB_BIFROST_SETUP_KEY}
      - NB_MANAGEMENT_URL=https://netbird.madhan.app
      - NB_HOSTNAME=bifrost-agent

  # --------------------------------------------------------------------------------
  # Authentik — GitHub OAuth broker + ForwardAuth for public K8s services
  # --------------------------------------------------------------------------------

  authentik-postgres:
    <<: *default
    image: postgres:16.6-alpine
    container_name: authentik-postgres
    networks: [bifrost_net]
    volumes:
      - authentik_postgres_data:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
      - POSTGRES_PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
      - POSTGRES_USER=authentik
      - POSTGRES_DB=authentik
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    security_opt:
      - no-new-privileges:true

  authentik-server:
    <<: *default
    image: ghcr.io/goauthentik/server:2025.10.4
    container_name: authentik-server
    command: server
    networks: [bifrost_net]
    env_file:
      - .env
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
    volumes:
      - authentik_media:/media
      - authentik_certs:/certs
    depends_on:
      authentik-postgres:
        condition: service_healthy
    labels:
      - traefik.enable=true
      - "traefik.http.routers.authentik.rule=Host(`auth.madhan.app`)"
      - traefik.http.routers.authentik.entrypoints=websecure
      - traefik.http.routers.authentik.tls.certResolver=cloudflare-dns
      - traefik.http.routers.authentik.service=authentik-svc
      - traefik.http.services.authentik-svc.loadbalancer.server.port=9000
    security_opt:
      - no-new-privileges:true

  authentik-worker:
    <<: *default
    image: ghcr.io/goauthentik/server:2025.10.4
    container_name: authentik-worker
    command: worker
    networks: [bifrost_net]
    env_file:
      - .env
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL_PASSWORD}
    volumes:
      - authentik_media:/media
      - authentik_certs:/certs
    depends_on:
      authentik-postgres:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
