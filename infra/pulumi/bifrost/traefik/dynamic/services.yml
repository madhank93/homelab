http:
  services:
    # Backend for all public K8s services (grafana, harbor, etc.)
    # Reachable via WireGuard mesh through netbird-agent
    k8s-gateway:
      loadBalancer:
        servers:
          - url: "http://192.168.1.220"

  middlewares:
    authentik-forwardauth:
      forwardAuth:
        address: "http://authentik-server:9000/outpost.goauthentik.io/auth/nginx"
        trustForwardHeader: true
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email

# NOTE: NetBird routing (netbird.madhan.app) is defined via Docker labels on the
# netbird-server and netbird-dashboard containers — see docker-compose.yml.
#
# NOTE: auth.madhan.app is defined via Docker labels on the authentik-server
# container — see docker-compose.yml.
#
# NOTE: Public K8s service routers (grafana, harbor) are in public-services.yml,
# generated by hetzner_vps.go on each `just pulumi hetzner up`.

tcp:
  routers:
    # TCP passthrough for NetBird expose feature (*.proxy.madhan.app)
    netbird-proxy:
      rule: "HostSNI(`*.proxy.madhan.app`) || HostSNI(`proxy.madhan.app`)"
      service: netbird-proxy-svc
      tls:
        passthrough: true
      priority: 100
  services:
    netbird-proxy-svc:
      loadBalancer:
        servers:
          - address: "netbird-proxy:8443"
